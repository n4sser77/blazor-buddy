@page "/canvas"
@rendermode InteractiveServer
@using BlazorBuddy.WebApp.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IJSRuntime JS
@inject ICanvasService CanvasService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Canvas</PageTitle>

<div class="canvas-container">
    <div class="canvas-controls">
        <h1>Canvas - Rita här</h1>

        <div class="control-group">
            <label>Pennfärg:</label>
            <input type="color" @onchange="OnColorChanged" value="#000000" />
        </div>
        
        <div class="control-group">
            <label>Penntjocklek:</label>
            <input type="range" min="1" max="20" value="2" @onchange="OnLineWidthChanged" />
        </div>
        
        <div class="control-group">
            <label>Verktyg:</label>
            <select @onchange="OnToolChanged" class="form-control">
                <option value="draw">Rita</option>
                <option value="text">Text</option>
            </select>
        </div>
        
        @if (currentTool == "text")
        {
            <div class="control-group">
                <label>Textstorlek:</label>
                <input type="range" min="8" max="48" value="16" @onchange="OnFontSizeChanged" />
            </div>
        }
        
        <div class="control-group">
            <button @onclick="ClearCanvas" class="btn btn-danger">Sudda</button>
            <button @onclick="SaveDrawing" class="btn btn-primary" disabled="@isSaving">@(isSaving ? "Sparar..." : "Spara ritning")</button>
        </div>
        
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert @(statusMessage.Contains("sparad") ? "alert-success" : "alert-danger")">
                @statusMessage
            </div>
        }
    </div>

    <canvas @ref="canvasRef" class="drawing-canvas"></canvas>
</div>

@code {
    private ElementReference canvasRef;
    private IJSObjectReference? module;
    private string currentTool = "draw";
    private int fontSize = 16;
    private string? currentUserId;
    private bool isSaving = false;
    private string statusMessage = "";
    
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/canvas.js");
            await module.InvokeVoidAsync("initCanvas", canvasRef);
        }
    }

    private async Task OnColorChanged(ChangeEventArgs e)
    {
        string color = e.Value?.ToString() ?? "#000000";
        if (module != null)
            await module.InvokeVoidAsync("setColor", color);
    }

    private async Task OnLineWidthChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int width))
        {
            if (module != null)
                await module.InvokeVoidAsync("setLineWidth", width);
        }
    }

    private async Task ClearCanvas()
    {
        if (module != null)
            await module.InvokeVoidAsync("clearCanvas");
    }
    

    private async Task SaveDrawing()
    {
        if (module == null || string.IsNullOrEmpty(currentUserId))
            return;
        
        try
        {
            isSaving = true;
            statusMessage = "";
            StateHasChanged();
            
            var canvasData = await module.InvokeAsync<string>("getCanvasImage");
            
            // Skapa canvas i databasen - här använder vi ett default noteId (Guid.Empty)
            // Du kan senare utöka detta så användaren kan välja vilken note canvas ska tillhöra
            var canvasName = $"Canvas {DateTime.Now:yyyy-MM-dd HH:mm}";
            var savedCanvas = await CanvasService.CreateCanvasAsync(canvasName, currentUserId, Guid.Empty);
            
            // Nu kan du uppdatera canvas med canvas data
            // Du behöver eventuellt lägga till en metod i service/repo för att uppdatera CanvasData
            
            statusMessage = $"Ritning sparad! (ID: {savedCanvas.Id})";
        }
        catch (Exception ex)
        {
            statusMessage = $"Fel vid sparande: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    // Byt mellan ritverktyg och textverktyg
    private async Task OnToolChanged(ChangeEventArgs e)
    {
        currentTool = e.Value?.ToString() ?? "draw";
        if (module != null)
        {
            await module.InvokeVoidAsync("setMode", currentTool);
        }
    }
    
    // Ändra fontstorlek
    private async Task OnFontSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int size))
        {
            fontSize = size;
            if (module != null)
            {
                await module.InvokeVoidAsync("setFontSize", size);
            }
        }
    }
}
