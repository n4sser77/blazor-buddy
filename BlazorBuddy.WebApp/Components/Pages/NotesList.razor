@page "/studypages/{StudyPageId:guid}/notes"
@attribute [Authorize]
@rendermode InteractiveServer
@using BlazorBuddy.Models
@using BlazorBuddy.WebApp.Repositories.Interfaces
@using BlazorBuddy.WebApp.Data
@using BlazorBuddy.WebApp.Services
@using Microsoft.AspNetCore.Authorization
@inject IStudyPageRepo StudyPageRepo
@inject INoteRepo NoteRepo
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ApplicationDbContext DbContext
@inject NotesStateService NotesStateService

<PageTitle>@studyPageTitle - Notes</PageTitle>

<div class="notes-list-container">
    <div class="back-button-section">
        <button class="btn-back" @onclick="GoBackToStudyPages">‚Üê Back to Study Pages</button>
    </div>
    
    <div class="header-section">
        <div>
            <h1>@studyPageTitle</h1>
            <p class="subtitle">@studyPageDescription</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowCreateDialog">+ Create New Note</button>
    </div>

    <div class="search-section">
        <input class="form-control search-input" 
               type="text" 
               placeholder=" Filter notes..." 
               @bind="searchQuery" 
               @bind:event="oninput" />
    </div>

    @if (isLoading)
    {
        <p class="text-muted">Loading notes...</p>
    }
    else if (filteredNotes.Count == 0)
    {
        <div class="empty-state">
            @if (string.IsNullOrWhiteSpace(searchQuery))
            {
                <p class="text-muted">No notes yet. Create your first note to get started!</p>
            }
            else
            {
                <p class="text-muted">No notes found matching "@searchQuery"</p>
            }
        </div>
    }
    else
    {
        <div class="notes-grid">
            @foreach (var note in filteredNotes)
            {
                <div class="note-card">
                    <div class="card-actions">
                        <button class="btn-icon" @onclick="() => ShowEditDialog(note)" @onclick:stopPropagation="true" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" @onclick="() => ShowDeleteConfirm(note.Id)" @onclick:stopPropagation="true" title="Delete">üóëÔ∏è</button>
                    </div>
                    <div @onclick="() => NavigateToNote(note.Id)">
                        <h3>@note.Title</h3>
                        <p class="content-preview">@GetContentPreview(note.Content)</p>
                        <div class="card-footer">
                            <span class="meta-info">üîó @note.Links.Count links</span>
                            <span class="meta-info">üè∑Ô∏è @note.Tags.Count tags</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @if (showCreateDialog)
    {
        <div class="modal-overlay" @onclick="HideCreateDialog">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Create New Note</h2>
                <div class="form-group">
                    <label>Title</label>
                    <input class="form-control" @bind="newTitle" placeholder="Enter note title" />
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea class="form-control" @bind="newContent" placeholder="Enter note content" rows="5"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" @onclick="CreateNote" disabled="@string.IsNullOrWhiteSpace(newTitle)">Create</button>
                    <button class="btn btn-secondary" @onclick="HideCreateDialog">Cancel</button>
                </div>
            </div>
        </div>
    }

    @if (showEditDialog)
    {
        <div class="modal-overlay" @onclick="HideEditDialog">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Edit Note</h2>
                <div class="form-group">
                    <label>Title</label>
                    <input class="form-control" @bind="editTitle" placeholder="Enter note title" />
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea class="form-control" @bind="editContent" placeholder="Enter note content" rows="5"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" @onclick="UpdateNote" disabled="@string.IsNullOrWhiteSpace(editTitle)">Save</button>
                    <button class="btn btn-secondary" @onclick="HideEditDialog">Cancel</button>
                </div>
            </div>
        </div>
    }

    @if (showDeleteConfirm)
    {
        <div class="modal-overlay" @onclick="HideDeleteConfirm">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Delete Note</h2>
                <p>Are you sure you want to delete this note? This action cannot be undone.</p>
                <div class="modal-actions">
                    <button class="btn btn-danger" @onclick="DeleteNote">Delete</button>
                    <button class="btn btn-secondary" @onclick="HideDeleteConfirm">Cancel</button>
                </div>
            </div>
        </div>
    }
</div>


@code {
    [Parameter]
    public Guid StudyPageId { get; set; }

    private List<NoteDocument> notes = new();
    private string studyPageTitle = "";
    private string studyPageDescription = "";
    private bool isLoading = true;
    private bool showCreateDialog = false;
    private bool showEditDialog = false;
    private bool showDeleteConfirm = false;
    private string newTitle = "";
    private string newContent = "";
    private string editTitle = "";
    private string editContent = "";
    private Guid editingNoteId = Guid.Empty;
    private Guid deletingNoteId = Guid.Empty;
    private string currentUserId = "";
    private string searchQuery = "";

    private List<NoteDocument> filteredNotes =>
        string.IsNullOrWhiteSpace(searchQuery)
            ? notes
            : notes.Where(n =>
                n.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                n.Content.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
            ).ToList();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
        }
        
        await LoadStudyPageInfo();
        await LoadNotes();
        isLoading = false;
    }

    private async Task LoadStudyPageInfo()
    {
        var studyPage = await StudyPageRepo.GetStudyPageByIdAsync(StudyPageId);
        if (studyPage != null)
        {
            studyPageTitle = studyPage.Title;
            studyPageDescription = studyPage.Description;
        }
    }

    private async Task LoadNotes()
    {
        // Check cache first
        if (NotesStateService.IsCacheValid(StudyPageId))
        {
            notes = NotesStateService.GetCachedNotes(StudyPageId) ?? new();
        }
        else
        {
            // Fetch from database and cache
            notes = await NoteRepo.GetNotesForStudyPageAsync(StudyPageId);
            NotesStateService.SetNotes(StudyPageId, notes);
        }
    }

    private void ShowCreateDialog()
    {
        showCreateDialog = true;
        newTitle = "";
        newContent = "";
    }

    private void HideCreateDialog()
    {
        showCreateDialog = false;
    }

    private async Task CreateNote()
    {
        if (string.IsNullOrWhiteSpace(newTitle) || string.IsNullOrWhiteSpace(currentUserId))
            return;

        // Get or create user profile
        var userProfile = await DbContext.UserProfiles.FindAsync(currentUserId);
        if (userProfile == null)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var username = authState.User.Identity?.Name ?? "User";
            
            userProfile = new UserProfile
            {
                Id = currentUserId,
                Username = username,
                DisplayName = username
            };
            DbContext.UserProfiles.Add(userProfile);
            await DbContext.SaveChangesAsync();
        }

        await NoteRepo.CreateNoteAsync(newTitle, newContent, userProfile, StudyPageId);
        NotesStateService.InvalidateCache(StudyPageId);
        await LoadNotes();
        HideCreateDialog();
    }

    private void NavigateToNote(Guid noteId)
    {
        NavigationManager.NavigateTo($"/studypages/{StudyPageId}/notes/{noteId}");
    }

    private string GetContentPreview(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "No content yet...";

        return content.Length > 150
            ? content.Substring(0, 150) + "..."
            : content;
    }

    private void ShowEditDialog(NoteDocument note)
    {
        editingNoteId = note.Id;
        editTitle = note.Title;
        editContent = note.Content;
        showEditDialog = true;
    }

    private void HideEditDialog()
    {
        showEditDialog = false;
    }

    private async Task UpdateNote()
    {
        if (string.IsNullOrWhiteSpace(editTitle))
            return;

        await NoteRepo.UpdateNoteAsync(editingNoteId, editTitle, editContent);
        NotesStateService.InvalidateCache(StudyPageId);
        await LoadNotes();
        HideEditDialog();
    }

    private void ShowDeleteConfirm(Guid noteId)
    {
        deletingNoteId = noteId;
        showDeleteConfirm = true;
    }

    private void HideDeleteConfirm()
    {
        showDeleteConfirm = false;
    }

    private async Task DeleteNote()
    {
        await NoteRepo.DeleteNoteAsync(deletingNoteId, currentUserId);
        NotesStateService.InvalidateCache(StudyPageId);
        await LoadNotes();
        HideDeleteConfirm();
    }

    private void GoBackToStudyPages()
    {
        NavigationManager.NavigateTo("/studypages");
    }
}
