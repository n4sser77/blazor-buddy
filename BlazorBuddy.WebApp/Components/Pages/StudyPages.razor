 @page "/studypages"
@rendermode InteractiveServer
@using BlazorBuddy.Models
@using BlazorBuddy.WebApp.Services
@using BlazorBuddy.WebApp.Repositories.Interfaces
@using BlazorBuddy.WebApp
@using Microsoft.AspNetCore.Authorization
@inject IStudyPageRepo StudyPageRepo
@inject StudyPageStateService StateService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@using BlazorBuddy.WebApp.Data
@inject ApplicationDbContext DbContext


<PageTitle>Study Pages</PageTitle>

<div class="study-pages-container">
    <div class="header-section">
        <h1>Study Pages</h1>
        <button class="btn btn-primary" @onclick="ShowCreateDialog">+ Create New Study Page</button>
    </div>

    <div class="search-section">
        <input class="form-control search-input" 
               type="text" 
               placeholder=" Filter study pages..." 
               @bind="searchQuery" 
               @bind:event="oninput" />
    </div>

    @if (isLoading)
    {
        <p class="text-muted">Loading your study pages...</p>
    }
    else if (filteredStudyPages.Count == 0)
    {
        <div class="empty-state">
            @if (string.IsNullOrWhiteSpace(searchQuery))
            {           
                <p class="text-muted">You don't have any study pages yet. Create one to get started!</p>
            }
            else
            {
                <p class="text-muted">No study pages found matching "@searchQuery"</p>
            }
        </div>
    }
    else
    {
        <div class="study-pages-grid">
            @foreach (var studyPage in filteredStudyPages)
            {
                <div class="study-page-card">
                    <div class="card-actions">
                        <button class="btn-icon" @onclick="() => ShowEditDialog(studyPage)" @onclick:stopPropagation="true" title="Edit">✏️</button>
                        <button class="btn-icon" @onclick="() => ShowDeleteConfirm(studyPage.Id)" @onclick:stopPropagation="true" title="Delete">🗑️</button>
                    </div>
                    <div @onclick="() => NavigateToNotes(studyPage.Id)">
                        <h3>@studyPage.Title</h3>
                        <p class="description">@studyPage.Description</p>
                        <div class="card-footer">
                            <span class="notes-count">📝 @studyPage.Notes.Count notes</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @if (showCreateDialog)
    {
        <div class="modal-overlay" @onclick="HideCreateDialog">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Create New Study Page</h2>
                <div class="form-group">
                    <label>Title</label>
                    <input class="form-control" @bind="newTitle" placeholder="Enter study page title" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" @bind="newDescription" placeholder="Enter description" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" @onclick="CreateStudyPage" disabled="@string.IsNullOrWhiteSpace(newTitle)">Create</button>
                    <button class="btn btn-secondary" @onclick="HideCreateDialog">Cancel</button>
                </div>
            </div>
        </div>
    }

    @if (showEditDialog)
    {
        <div class="modal-overlay" @onclick="HideEditDialog">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Edit Study Page</h2>
                <div class="form-group">
                    <label>Title</label>
                    <input class="form-control" @bind="editTitle" placeholder="Enter study page title" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" @bind="editDescription" placeholder="Enter description" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" @onclick="UpdateStudyPage" disabled="@string.IsNullOrWhiteSpace(editTitle)">Save</button>
                    <button class="btn btn-secondary" @onclick="HideEditDialog">Cancel</button>
                </div>
            </div>
        </div>
    }

    @if (showDeleteConfirm)
    {
        <div class="modal-overlay" @onclick="HideDeleteConfirm">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Delete Study Page</h2>
                <p>Are you sure you want to delete this study page? This action cannot be undone.</p>
                <div class="modal-actions">
                    <button class="btn btn-danger" @onclick="DeleteStudyPage">Delete</button>
                    <button class="btn btn-secondary" @onclick="HideDeleteConfirm">Cancel</button>
                </div>
            </div>
        </div>
    }
</div>


@code {
    private List<StudyPage> studyPages = new();
    private bool isLoading = true;
    private bool showCreateDialog = false;
    private bool showEditDialog = false;
    private bool showDeleteConfirm = false;
    private string newTitle = "";
    private string newDescription = "";
    private string editTitle = "";
    private string editDescription = "";
    private Guid editingStudyPageId = Guid.Empty;
    private Guid deletingStudyPageId = Guid.Empty;
    private string currentUserId = "";
    private string searchQuery = "";

    private List<StudyPage> filteredStudyPages => 
        string.IsNullOrWhiteSpace(searchQuery) 
            ? studyPages 
            : studyPages.Where(sp => 
                sp.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) || 
                sp.Description.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
            ).ToList();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            await LoadStudyPages();
        }
        
        isLoading = false;
    }

    private async Task LoadStudyPages()
    {
        // Check cache first
        if (StateService.IsCacheValid())
        {
            studyPages = StateService.CachedStudyPages ?? new();
        }
        else
        {
            // Fetch from database and cache
            studyPages = await StudyPageRepo.GetUserStudyPagesAsync(currentUserId);
            StateService.SetStudyPages(studyPages);
        }
    }

    private void ShowCreateDialog()
    {
        showCreateDialog = true;
        newTitle = "";
        newDescription = "";
    }

    private void HideCreateDialog()
    {
        showCreateDialog = false;
    }

    private async Task CreateStudyPage()
    {
        if (string.IsNullOrWhiteSpace(newTitle) || string.IsNullOrWhiteSpace(currentUserId))
            return;

        // Get or create the user profile from database
        var userProfile = await DbContext.UserProfiles.FindAsync(currentUserId);
        if (userProfile == null)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var username = authState.User.Identity?.Name ?? "User";
            
            userProfile = new UserProfile
            {
                Id = currentUserId,
                Username = username,
                DisplayName = username
            };
            DbContext.UserProfiles.Add(userProfile);
            await DbContext.SaveChangesAsync();
        }

        await StudyPageRepo.CreateStudyPageAsync(newTitle, newDescription, userProfile);
        
        // Invalidate cache when creating new study page
        StateService.InvalidateCache();
        
        await LoadStudyPages();
        HideCreateDialog();
    }

    private void ShowEditDialog(StudyPage studyPage)
    {
        editingStudyPageId = studyPage.Id;
        editTitle = studyPage.Title;
        editDescription = studyPage.Description;
        showEditDialog = true;
    }

    private void HideEditDialog()
    {
        showEditDialog = false;
    }

    private async Task UpdateStudyPage()
    {
        if (string.IsNullOrWhiteSpace(editTitle))
            return;

        await StudyPageRepo.UpdateStudyPageAsync(editingStudyPageId, editTitle, editDescription);
        StateService.InvalidateCache();
        await LoadStudyPages();
        HideEditDialog();
    }

    private void ShowDeleteConfirm(Guid studyPageId)
    {
        deletingStudyPageId = studyPageId;
        showDeleteConfirm = true;
    }

    private void HideDeleteConfirm()
    {
        showDeleteConfirm = false;
    }

    private async Task DeleteStudyPage()
    {
        await StudyPageRepo.DeleteStudyPageAsync(deletingStudyPageId, currentUserId);
        StateService.InvalidateCache();
        await LoadStudyPages();
        HideDeleteConfirm();
    }

    private void NavigateToNotes(Guid studyPageId)
    {
        NavigationManager.NavigateTo($"/studypages/{studyPageId}/notes");
    }
}
