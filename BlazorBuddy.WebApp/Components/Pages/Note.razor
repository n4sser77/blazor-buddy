@page "/studypages/{StudyPageId:guid}/notes/{NoteId:guid}"
@using BlazorBuddy.Models
@using BlazorBuddy.WebApp.Repositories.Interfaces
@using PSC.Blazor.Components.MarkdownEditor
@using PSC.Blazor.Components.MarkdownEditor.Enums
@using PSC.Blazor.Components.MarkdownEditor.EventsArgs
@inject INoteRepo NoteRepo
@inject NavigationManager NavigationManager
@rendermode InteractiveServer



@if (CurrentNote != null)
{
    <div class="note-editor-container">
        <div class="header-actions">
            <button class="btn-back" @onclick="GoBack">← Back to Notes</button>
            <button class="toggle-btn" @onclick="ToggleView">
                @(ShowPreview ? "✏️ Edit" : "👁️ Preview")
            </button>
        </div>

        <div class="title-section">
            <input class="note-title-input" 
                   type="text" 
                   @bind="CurrentNote.Title" 
                   @bind:event="oninput"
                   placeholder="Note title..." />
        </div>

        @if (!ShowPreview)
        {
            <MarkdownEditor @bind-Value="CurrentNote.Content"
                            ValueHTMLChanged="@OnMarkdownValueHTMLChanged"
                            MinHeight="300px"
                            MaxHeight="700px"
                            SpellChecker="true">

                <Toolbar>
                    <MarkdownToolbarButton Action="MarkdownAction.Bold" Icon="fa fa-bold" Title="Bold" />
                    <MarkdownToolbarButton Action="MarkdownAction.Italic" Icon="fa fa-italic" Title="Italic" />
                    <MarkdownToolbarButton Action="MarkdownAction.Strikethrough" Icon="fa fa-strikethrough" Title="Strikethrough" />
                    <MarkdownToolbarButton Action="MarkdownAction.Heading" Icon="fa fa-header" Title="Heading" />
                    <MarkdownToolbarButton Action="MarkdownAction.Quote" Icon="fa fa-quote-left" Title="Blockquote" />
                    <MarkdownToolbarButton Action="MarkdownAction.UnorderedList" Icon="fa fa-list-ul" Title="Unordered List" />
                    <MarkdownToolbarButton Action="MarkdownAction.OrderedList" Icon="fa fa-list-ol" Title="Ordered List" />
                    <MarkdownToolbarButton Action="MarkdownAction.Link" Icon="fa fa-link" Title="Link" />
                    <MarkdownToolbarButton Action="MarkdownAction.Image" Icon="fa fa-picture-o" Title="Image" />
                    <MarkdownToolbarButton Action="MarkdownAction.Code" Icon="fa fa-code" Title="Code Block" />
                    <MarkdownToolbarButton Action="MarkdownAction.HorizontalRule" Icon="fa fa-minus" Title="Horizontal Rule" />
                    <MarkdownToolbarButton Action="MarkdownAction.Preview" Icon="fa fa-eye" Title="Preview" />
                    <MarkdownToolbarButton Action="MarkdownAction.SideBySide" Icon="fa fa-columns" Title="Side by Side" />
                    <MarkdownToolbarButton Action="MarkdownAction.Fullscreen" Icon="fa fa-arrows-alt" Title="Fullscreen" />
                </Toolbar>

            </MarkdownEditor>
        }
        else
        {
            <div class="preview-area" @onclick="ToggleView">
                @((MarkupString)markdownHtml)
            </div>
        }
    </div>

}
else
{
    <p>Loading note...</p>
}



@code {
    [Parameter]
    public Guid StudyPageId { get; set; }

    [Parameter]
    public Guid NoteId { get; set; }

    private NoteDocument? CurrentNote;
    private string markdownHtml = "";
    private bool ShowPreview = false;

    private async Task ToggleView()
    {
        ShowPreview = !ShowPreview;
        await SaveNote();
    }

    protected override async Task OnInitializedAsync()
    {
        CurrentNote = await NoteRepo.GetNoteByIdAsync(NoteId);
       await NoteRepo.UpdateVisitedAtAsync(NoteId, DateTime.UtcNow);
       

        if (CurrentNote == null)
        {
            // Note not found, redirect back to notes list
            NavigationManager.NavigateTo($"/studypages/{StudyPageId}/notes");
        }
    }

    private async Task SaveNote()
    {
        if (CurrentNote != null)
        {
            await NoteRepo.UpdateNoteAsync(NoteId, CurrentNote.Title, CurrentNote.Content);
        }
    }

    private Task OnMarkdownValueHTMLChanged(string value)
    {
        markdownHtml = value;
        return Task.CompletedTask;
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo($"/studypages/{StudyPageId}/notes");
    }
}
